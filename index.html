<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Authorization</title>
</head>
<body>

    <h1>Spotify Authorization Example</h1>

    <script>
        // Function to generate a random string
        const generateRandomString = (length) => {
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            const values = crypto.getRandomValues(new Uint8Array(length));
            return values.reduce((acc, x) => acc + possible[x % possible.length], "");
        }

        // Function to hash using SHA256 algorithm
        const sha256 = async (plain) => {
            const encoder = new TextEncoder()
            const data = encoder.encode(plain)
            return window.crypto.subtle.digest('SHA-256', data)
        }

        // Function to base64 encode
        const base64encode = (input) => {
            return btoa(String.fromCharCode(...new Uint8Array(input)))
                .replace(/=/g, '')
                .replace(/\+/g, '-')
                .replace(/\//g, '_');
        }

        // Function to get URL parameters
        const getParameterByName = (name, url) => {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            const regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        // Function to initiate authorization
        const initiateAuthorization = () => {
            const clientId = 'YOUR_CLIENT_ID';
            const redirectUri = 'http://localhost:8080';

            // Generate code verifier
            const codeVerifier = generateRandomString(64);

            // Save code verifier in local storage
            window.localStorage.setItem('code_verifier', codeVerifier);

            // Generate code challenge
            sha256(codeVerifier)
                .then(hashed => base64encode(hashed))
                .then(codeChallenge => {
                    const authUrl = new URL("https://accounts.spotify.com/authorize");
                    const scope = 'user-read-private user-read-email';

                    // Append parameters to authorization URL
                    const params =  {
                        response_type: 'code',
                        client_id: clientId,
                        scope,
                        code_challenge_method: 'S256',
                        code_challenge,
                        redirect_uri: redirectUri,
                    }

                    authUrl.search = new URLSearchParams(params).toString();

                    // Redirect to Spotify authorization page
                    window.location.href = authUrl.toString();
                });
        }

        // Check if there's a code in the query string
        const authorizationCode = getParameterByName('code');

        if (authorizationCode) {
            // Display a message for successful authorization
            document.body.innerHTML += '<p>Hai fatto l\'accesso con Spotify</p>';

            // Continue with token exchange (if needed)
            const clientId = '53314da027904a1fbd04c75ade00fa06';
            const redirectUri = 'http://localhost:8888/callback';

            // Get stored code verifier
            const codeVerifier = window.localStorage.getItem('code_verifier');

            // Token exchange payload
            const payload = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    client_id: clientId,
                    grant_type: 'authorization_code',
                    code: authorizationCode,
                    redirect_uri: redirectUri,
                    code_verifier: codeVerifier,
                }),
            }

            // Token exchange URL
            const tokenUrl = 'https://accounts.spotify.com/api/token';

            // Perform the token exchange
            fetch(tokenUrl, payload)
                .then(response => response.json())
                .then(data => {
                    // Handle the token response as needed
                    window.localStorage.setItem('access_token', data.access_token);
                    console.log('Access Token:', data.access_token);
                })
                .catch(error => console.error('Error fetching token:', error));
        }
    </script>

    <button onclick="initiateAuthorization()">Authorize with Spotify</button>

</body>
</html>
